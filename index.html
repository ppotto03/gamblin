<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore,doc,getDoc,updateDoc,increment,arrayUnion,collection,addDoc,getDocs,query,orderBy,deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyDOVJtg5lxJTBP2Vm1mzbuecKu9Rg-I4k4",
 authDomain:"gambling-23339.firebaseapp.com",
 projectId:"gambling-23339"
});
const auth=getAuth(app), db=getFirestore(app);

let userObj=null, isAdmin=false, curBal=0, soundEnabled=false;

const playSnd=id=>{
 if(!soundEnabled) return;
 const s=document.getElementById(id);
 if(s){ s.currentTime=0; s.play(); }
};

onAuthStateChanged(auth, async user=>{
 if(!user) return;
 userObj=user;
 const snap=await getDoc(doc(db,"users",user.uid));
 isAdmin = snap.data().role === "admin";
 curBal = snap.data().balance;
 assetVal.innerText = curBal.toLocaleString();
 if(isAdmin) adminBadge.style.display="inline";
 loadCS();
});

window.toggleSound=()=>{
 soundEnabled=!soundEnabled;
 soundBtn.innerText = soundEnabled ? "ðŸ”Š ì‚¬ìš´ë“œ ON" : "ðŸ”‡ ì‚¬ìš´ë“œ OFF";
};

async function applyResult(bet,mul,game){
 const profit = Math.floor(bet*mul - bet);
 await updateDoc(doc(db,"users",userObj.uid),{
  balance:increment(profit),
  history:arrayUnion({game,bet,profit,time:new Date().toISOString()})
 });
 curBal+=profit;
 assetVal.innerText=curBal.toLocaleString();
 playSnd(profit>0?"sndWin":"sndLose");
}

/* ìŠ¬ë¡¯ */
const syms=['ðŸŽ','ðŸŠ','ðŸ‡','ðŸ’','ðŸ’Ž','7ï¸âƒ£'];
window.playSlot=async()=>{
 const bet=+slotBet.value;
 if(bet<=0||bet>curBal) return alert("ë¨¸ë‹ˆ ë¶€ì¡±");
 playSnd("sndSpin");
 reels.innerText="ðŸ”„ | ðŸ”„ | ðŸ”„";
 setTimeout(async()=>{
  const r=[syms[Math.random()*6|0],syms[Math.random()*6|0],syms[Math.random()*6|0]];
  reels.innerText=r.join(" | ");
  playSnd("sndSlotResult");

  let mul=0;
  if(r.every(v=>v==='7ï¸âƒ£')) mul=17.7;
  else if(r.filter(v=>v==='7ï¸âƒ£').length===2) mul=4;
  else if(new Set(r).size===2) mul=3;

  await applyResult(bet,mul,"ìŠ¬ë¡¯");
 },1500);
};

/* ë°”ì¹´ë¼ */
window.playBac=async pick=>{
 const bet=+bacBet.value;
 if(bet<=0||bet>curBal) return alert("ë¨¸ë‹ˆ ë¶€ì¡±");
 playSnd("sndCard");
 const win=['player','banker','tie'][Math.random()*3|0];
 const mul = (pick===win) ? (win==='tie'?9.8:2.8) : 0;
 await applyResult(bet,mul,"ë°”ì¹´ë¼");
 alert("ê²°ê³¼: "+win.toUpperCase());
};

/* ë‹¬íŒ½ì´ */
window.playSnail=async()=>{
 const bet=+snailBet.value;
 const pick=+document.querySelector("[name=snailPick]:checked").value;
 playSnd("sndSnail");
 const win=Math.random()*3|0;
 await applyResult(bet, win===pick?2.8:0, "ë‹¬íŒ½ì´");
 alert(`${win+1}ë²ˆ ìš°ìŠ¹`);
};

/* ê³ ê°ì„¼í„° */
window.writeCS=async()=>{
 await addDoc(collection(db,"cs"),{
  uid:userObj.uid,
  email:userObj.email,
  title:csTitle.value,
  content:csContent.value,
  secret:csSecret.checked,
  time:new Date().toISOString()
 });
 loadCS();
};

async function loadCS(){
 const q=query(collection(db,"cs"),orderBy("time","desc"));
 const snap=await getDocs(q);
 csTableBody.innerHTML=snap.docs.map(d=>{
  const v=d.data();
  const can=!v.secret||v.uid===userObj.uid||isAdmin;
  return `
  <tr>
   <td>${v.secret?'ðŸ”’':'ðŸ“¢'}</td>
   <td onclick="alert('${can?v.content:'ë¹„ë°€ê¸€'}')">${can?v.title:'ë¹„ë°€ê¸€'}</td>
   <td>${v.email.split('@')[0]}</td>
   ${isAdmin?`<td><button onclick="delCS('${d.id}')">ì‚­ì œ</button></td>`:''}
  </tr>`;
 }).join("");
}

window.delCS=async id=>{
 if(confirm("ì‚­ì œ?")){
  await deleteDoc(doc(db,"cs",id));
  loadCS();
 }
};
</script>
