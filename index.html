<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gambling Prevention Portal v3.0</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // ğŸ”¥ ë³¸ì¸ì˜ Firebase ì„¤ì •ê°’ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        const firebaseConfig = {
  apiKey: "AIzaSyDOVJtg5lxJTBP2Vm1mzbuecKu9Rg-I4k4",
  authDomain: "gambling-23339.firebaseapp.com",
  projectId: "gambling-23339",
  storageBucket: "gambling-23339.firebasestorage.app",
  messagingSenderId: "1031894079454",
  appId: "1:1031894079454:web:960ca0f1748493cdd9af4f",
  measurementId: "G-GT74F5GVR2"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userDoc = null;
        let userData = { balance: 0, nickname: "", role: "user", history: [] };

        // --- UI ì „í™˜ ë° ì´ˆê¸°í™” ---
        window.showView = async (viewId) => {
            // ë°”ì¹´ë¼ ì…ì¥ ì „ ë£° íŒì—… ì²˜ë¦¬
            if (viewId === 'baccaratGame' && document.getElementById('baccaratGame').style.display === 'none') {
                if (!confirm("â™£ï¸ ë°”ì¹´ë¼ ê²Œì„ ë£° ì„¤ëª… â™£ï¸\n\n1. í”Œë ˆì´ì–´ vs ë±…ì»¤ ì¤‘ í•©ì´ 9ì— ê°€ê¹Œìš´ ìª½ì„ ë§ì¶”ëŠ” ê²Œì„ì…ë‹ˆë‹¤.\n2. 10, J, Q, KëŠ” 0ì , AëŠ” 1ì , ë‚˜ë¨¸ì§€ëŠ” ìˆ«ì ê·¸ëŒ€ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.\n3. í•©ì´ 10ì´ ë„˜ìœ¼ë©´ ì¼ì˜ ìë¦¬ ìˆ«ìë§Œ ë”°ì§‘ë‹ˆë‹¤.\n4. ë§ì¶œ ì‹œ í”Œë ˆì´ì–´/ë±…ì»¤ëŠ” 2ë°°, íƒ€ì´ëŠ” 8ë°°ë¥¼ ë°›ìŠµë‹ˆë‹¤.\n\nì…ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            }

            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            
            if (userDoc) {
                const snap = await getDoc(userDoc);
                userData = snap.data();
                updateUI();
            }
            if (viewId === 'snailGame') drawSnailRace();
            if (viewId === 'baccaratGame') resetBaccaratTable();
        };

        // --- ê³µí†µ UI ì—…ë°ì´íŠ¸ (í¬ì¸íŠ¸ ì˜¤ë¥˜ ìˆ˜ì •) ---
        function updateUI() {
            const elements = document.querySelectorAll('.balance-txt');
            elements.forEach(el => el.innerText = (userData.balance || 0).toLocaleString());
            
            if(document.getElementById('lobby-nick')) document.getElementById('lobby-nick').innerText = userData.nickname;
            
            // ê¸°ë¡ ê´€ë¦¬ (ë‹¬íŒ½ì´/ë°”ì¹´ë¼ ê¸°ë¡ í•©ì¹˜ê¸°)
            const historyBody = document.getElementById('historyBody');
            if (historyBody && userData.history) {
                historyBody.innerHTML = userData.history.slice().reverse().map((h, i) => `
                    <tr>
                        <td>${h.game === 'snail' ? 'ğŸŒ' : 'ğŸƒ'}</td>
                        <td>${h.bet}</td>
                        <td>${h.result}</td>
                        <td style="color:${h.profit >= 0 ? '#4ade80' : '#fb7185'}">${h.profit.toLocaleString()}</td>
                    </tr>
                `).join('');
            }
            if(userData.role === 'admin') document.getElementById('admin-btn').style.display = 'block';
        }

        // --- ë¡œê·¸ì¸/íšŒì›ê°€ì… ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userDoc = doc(db, "users", user.uid);
                const snap = await getDoc(userDoc);
                userData = snap.data();
                updateUI();
                showView('lobby');
            } else {
                showView('login');
            }
        });

        window.handleAuth = async (mode) => {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('pw').value;
            const nick = document.getElementById('nickname').value;
            try {
                if (mode === 'signup') {
                    const res = await createUserWithEmailAndPassword(auth, email, pw);
                    await setDoc(doc(db, "users", res.user.uid), { nickname: nick || "ìµëª…", balance: 100000, role: "user", history: [] });
                } else {
                    await signInWithEmailAndPassword(auth, email, pw);
                }
            } catch (e) { alert(e.message); }
        };

        // --- í¬ì¸íŠ¸ ê´€ë¦¬ í•¨ìˆ˜ ---
        async function updatePoints(profit, gameType, betInfo, resultInfo) {
            await updateDoc(userDoc, {
                balance: increment(profit),
                history: arrayUnion({
                    game: gameType,
                    bet: betInfo,
                    result: resultInfo,
                    profit: profit,
                    time: new Date().toISOString()
                })
            });
            const snap = await getDoc(userDoc);
            userData = snap.data();
            updateUI();
        }

        // --- [ê²Œì„ 1] ë‹¬íŒ½ì´ ë ˆì´ì‹± (ì—”ë“œë¼ì¸ ìˆ˜ì •) ---
        let isRacing = false;
        const snailColors = ["#ff5e57", "#48dbfb", "#1dd1a1"];
        function drawSnailRace(positions = [60, 60, 60]) {
            const canvas = document.getElementById('snailCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,800,300);
            
            // ì—”ë“œë¼ì¸(ê²°ìŠ¹ì„ ) ê·¸ë¦¬ê¸°
            ctx.strokeStyle = "#ff4d4d";
            ctx.lineWidth = 5;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(720, 0); ctx.lineTo(720, 300);
            ctx.stroke();
            ctx.setLineDash([]);

            for(let i=0; i<3; i++) {
                const y = 50 + i*90;
                ctx.fillStyle = snailColors[i];
                ctx.beginPath(); ctx.arc(positions[i], y, 20, 0, 7); ctx.fill(); // ë‹¬íŒ½ì´ ì§‘
                ctx.fillStyle = "#f0d0b0";
                ctx.fillRect(positions[i], y+10, 30, 10); // ëª¸í†µ
                ctx.fillStyle = "white";
                ctx.fillText(i+1 + "ë²ˆ", positions[i]-10, y+5);
            }
        }

        window.startSnailRace = async () => {
            const betInput = document.getElementById('snail-bet');
            const bet = parseInt(betInput.value);
            if(isRacing || bet > userData.balance || bet <= 0) return;

            isRacing = true;
            document.getElementById('snail-btn').disabled = true;
            await updatePoints(-bet, 'snail', 'ë¯¸ì„ íƒ', 'ì§„í–‰ì¤‘'); // ìš°ì„  ì°¨ê°

            let positions = [60, 60, 60];
            let winner = null;
            while(!winner) {
                for(let i=0; i<3; i++) {
                    positions[i] += Math.random() * 8 + 2;
                    if(positions[i] >= 720) { winner = i; break; }
                }
                drawSnailRace(positions);
                await new Promise(r => setTimeout(r, 40));
            }

            const selected = parseInt(document.querySelector('input[name="snail"]:checked').value);
            let profit = 0;
            if(selected === winner) profit = Math.floor(bet * 2.8);
            
            alert(`${winner+1}ë²ˆ ë‹¬íŒ½ì´ ìŠ¹ë¦¬!`);
            await updatePoints(profit, 'snail', (selected+1)+'ë²ˆ ì„ íƒ', (winner+1)+'ë²ˆ ìš°ìŠ¹');
            isRacing = false;
            document.getElementById('snail-btn').disabled = false;
        };

        // --- [ê²Œì„ 2] ë°”ì¹´ë¼ ì‹œê°í™” (ì¹´ë“œ ì—°ì¶œ) ---
        function resetBaccaratTable() {
            document.getElementById('p-cards').innerHTML = '';
            document.getElementById('b-cards').innerHTML = '';
            document.getElementById('bac-status').innerText = 'ë² íŒ…ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
        }

        window.playBaccarat = async (pick) => {
            const bet = parseInt(document.getElementById('bac-bet').value);
            if(bet > userData.balance || bet <= 0) return;

            resetBaccaratTable();
            document.querySelectorAll('.bac-btns button').forEach(b => b.disabled = true);
            await updatePoints(-bet, 'baccarat', pick, 'ì§„í–‰ì¤‘');

            const status = document.getElementById('bac-status');
            
            // ì¹´ë“œ ë½‘ê¸° ì—°ì¶œ
            const p1 = Math.floor(Math.random() * 10);
            const b1 = Math.floor(Math.random() * 10);
            const p2 = Math.floor(Math.random() * 10);
            const b2 = Math.floor(Math.random() * 10);

            const dealCard = (target, val) => {
                const card = document.createElement('div');
                card.className = 'card-obj';
                card.innerText = val === 0 ? 'K' : val;
                document.getElementById(target).appendChild(card);
            };

            status.innerText = 'í”Œë ˆì´ì–´ ì¹´ë“œ ë¶„ë°° ì¤‘...';
            await new Promise(r => setTimeout(r, 800)); dealCard('p-cards', p1);
            await new Promise(r => setTimeout(r, 600)); dealCard('p-cards', p2);

            status.innerText = 'ë±…ì»¤ ì¹´ë“œ ë¶„ë°° ì¤‘...';
            await new Promise(r => setTimeout(r, 800)); dealCard('b-cards', b1);
            await new Promise(r => setTimeout(r, 600)); dealCard('b-cards', b2);

            const pScore = (p1 + p2) % 10;
            const bScore = (b1 + b2) % 10;
            
            let result = "tie";
            if(pScore > bScore) result = "player";
            else if(bScore > pScore) result = "banker";

            status.innerText = `ê²°ê³¼ í™•ì¸: í”Œë ˆì´ì–´ ${pScore} vs ë±…ì»¤ ${bScore}`;
            await new Promise(r => setTimeout(r, 1000));

            let profit = 0;
            if(pick === result) {
                profit = result === 'tie' ? bet * 8 : bet * 2;
                alert(`ì¶•í•˜í•©ë‹ˆë‹¤! ${result} ë‹¹ì²¨!`);
            } else {
                alert(`ì•„ì‰½ë„¤ìš”. ${result} ìŠ¹ë¦¬.`);
            }

            await updatePoints(profit, 'baccarat', pick, `P:${pScore} B:${bScore}`);
            document.querySelectorAll('.bac-btns button').forEach(b => b.disabled = false);
        };

        window.allIn = (id) => { document.getElementById(id).value = userData.balance; };
        window.adminAdd = async () => {
            const uid = prompt("UID ì…ë ¥:");
            const amt = parseInt(prompt("ê¸ˆì•¡ ì…ë ¥:"));
            await updateDoc(doc(db, "users", uid), { balance: increment(amt) });
            alert("ì™„ë£Œ");
        };

    </script>
    <style>
        body { background: #1a1a1a; color: white; text-align: center; font-family: 'Pretendard', sans-serif; margin: 0; }
        .view { display: none; padding: 20px; }
        .card { background: #2d2d2d; padding: 25px; border-radius: 15px; display: inline-block; margin-top: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        input { padding: 12px; margin: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 5px; }
        button { padding: 12px 24px; background: #27ae60; color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; }
        button:hover { background: #2ecc71; }
        .all-in { background: #e67e22; margin-left: 5px; }
        canvas { background: #222; border: 3px solid #333; margin: 20px auto; display: block; border-radius: 10px; }
        
        /* ë°”ì¹´ë¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .baccarat-table { display: flex; justify-content: center; gap: 40px; margin: 20px 0; }
        .side { background: #145a32; padding: 20px; border-radius: 10px; min-width: 150px; min-height: 120px; border: 2px solid #1e8449; }
        .card-obj { width: 50px; height: 75px; background: white; color: black; display: inline-block; margin: 5px; border-radius: 5px; line-height: 75px; font-weight: bold; font-size: 20px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); animation: flip 0.5s; }
        @keyframes flip { from { transform: rotateY(90deg); } to { transform: rotateY(0deg); } }
        
        table { width: 80%; margin: 20px auto; border-collapse: collapse; background: #2d2d2d; font-size: 14px; }
        th, td { border: 1px solid #444; padding: 10px; }
        th { background: #3d3d3d; }
    </style>
</head>
<body>

    <div id="login" class="view">
        <div class="card">
            <h2>ğŸ›¡ï¸ ì²­ì†Œë…„ ë„ë°• ì˜ˆë°© êµìœ¡ ì‚¬ì´íŠ¸</h2>
            <input type="email" id="email" placeholder="ì´ë©”ì¼"><br>
            <input type="password" id="pw" placeholder="ë¹„ë°€ë²ˆí˜¸"><br>
            <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ (ìµœì´ˆ ê°€ì… ì‹œ)"><br>
            <button onclick="handleAuth('login')">ë¡œê·¸ì¸</button>
            <button onclick="handleAuth('signup')" style="background:#2980b9">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="lobby" class="view">
        <h1>Welcome, <span id="lobby-nick"></span>!</h1>
        <div style="font-size: 24px; margin: 20px; color: #f1c40f;">ë³´ìœ  í¬ì¸íŠ¸: <span class="balance-txt">0</span> P</div>
        <button onclick="showView('snailGame')" style="font-size:20px; padding:40px;">ğŸŒ ë‹¬íŒ½ì´ ê²½ì£¼ ì‹œì‘</button>
        <button onclick="showView('baccaratGame')" style="font-size:20px; padding:40px; background:#c0392b;">ğŸƒ ë°”ì¹´ë¼ ì…ì¥</button>
        <div style="margin-top:40px;">
            <h3>ìµœê·¼ ê²Œì„ ê¸°ë¡</h3>
            <table>
                <thead><tr><th>ì¢…ëª©</th><th>ë² íŒ… ì •ë³´</th><th>ê²°ê³¼</th><th>ìˆ˜ìµ</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
        <button id="admin-btn" onclick="adminAdd()" style="display:none; background:#8e44ad; margin-top:20px;">ğŸ”§ ê´€ë¦¬ì í¬ì¸íŠ¸ ì§€ê¸‰</button>
    </div>

    <div id="snailGame" class="view">
        <button onclick="showView('lobby')">â¬… ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
        <h2>ğŸŒ ë‹¬íŒ½ì´ ê²½ì£¼ (ì”ì•¡: <span class="balance-txt"></span>P)</h2>
        <canvas id="snailCanvas" width="800" height="300"></canvas>
        <div style="margin: 10px;">
            <input type="radio" name="snail" value="0" checked> 1ë²ˆ | 
            <input type="radio" name="snail" value="1"> 2ë²ˆ | 
            <input type="radio" name="snail" value="2"> 3ë²ˆ
        </div>
        <input type="number" id="snail-bet" value="10000">
        <button class="all-in" onclick="allIn('snail-bet')">ALL-IN</button>
        <button id="snail-btn" onclick="startSnailRace()">ê²½ê¸° ì‹œì‘!</button>
    </div>

    <div id="baccaratGame" class="view">
        <button onclick="showView('lobby')">â¬… ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
        <h2>ğŸƒ ë¦¬ì–¼ ë°”ì¹´ë¼ í…Œì´ë¸”</h2>
        <div style="color: #f1c40f; margin-bottom: 10px;">ì”ì•¡: <span class="balance-txt"></span>P</div>
        <div id="bac-status" style="font-weight: bold; color: #2ecc71; margin: 10px;">ë² íŒ…ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
        
        <div class="baccarat-table">
            <div class="side">
                <div style="margin-bottom:10px;">PLAYER</div>
                <div id="p-cards"></div>
            </div>
            <div class="side" style="background: #78281f; border-color: #943126;">
                <div style="margin-bottom:10px;">BANKER</div>
                <div id="b-cards"></div>
            </div>
        </div>

        <div class="bac-btns">
            <input type="number" id="bac-bet" value="10000" style="width:150px;">
            <button class="all-in" onclick="allIn('bac-bet')">ALL-IN</button><br><br>
            <button onclick="playBaccarat('player')">PLAYER (2x)</button>
            <button onclick="playBaccarat('tie')" style="background:#8e44ad">TIE (8x)</button>
            <button onclick="playBaccarat('banker')" style="background:#c0392b">BANKER (2x)</button>
        </div>
    </div>

</body>
</html>