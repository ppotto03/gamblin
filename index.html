<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S SUPER 9 BET | PREMIUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --point-gold: #eebb4d; --bg-dark: #0a0a0a; --panel-bg: #151515; }
        body { background-color: var(--bg-dark); color: #eee; font-family: 'Noto Sans KR', sans-serif; margin: 0; overflow: hidden; }

        /* ê²°ê³¼ íŒì—… */
        #resultPopup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; 
                       background: #000; border: 3px solid var(--point-gold); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px gold; min-width: 300px; }
        .win-title { color: gold; font-size: 40px; text-shadow: 0 0 10px gold; }
        .lose-title { color: #ff5252; font-size: 40px; }

        /* ë„¤ë¹„ê²Œì´ì…˜ (ê³ ê°ì„¼í„° ìƒë‹¨ ìš°ì¸¡ ë°°ì¹˜) */
        .top-nav { background: linear-gradient(180deg, #1b5e20, #0a2e10); height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; border-bottom: 2px solid #222; }
        .logo { font-size: 26px; font-weight: 900; color: #fff; cursor: pointer; font-style: italic; letter-spacing: -1px; }
        .nav-right { display: flex; align-items: center; gap: 25px; }
        .asset-box { background: #000; padding: 10px 20px; border-radius: 5px; border: 1px solid gold; color: gold; font-weight: 900; font-size: 18px; }
        .user-menu { font-size: 13px; display: flex; gap: 15px; color: #ccc; }
        .user-menu span { cursor: pointer; transition: 0.2s; }
        .user-menu span:hover { color: gold; }

        /* ë ˆì´ì•„ì›ƒ */
        .main-wrapper { display: flex; height: calc(100vh - 70px); }
        .sidebar { width: 200px; background: #0d0d0d; border-right: 1px solid #222; padding-top: 20px; }
        .menu-item { padding: 15px 25px; cursor: pointer; color: #777; font-weight: 700; border-left: 4px solid transparent; }
        .menu-active { background: #1a1a1a; border-left: 4px solid gold; color: gold; }

        .content { flex: 1; padding: 30px; overflow-y: auto; background: radial-gradient(circle at center, #1a1a1a, #0a0a0a); }

        /* ê²Œì„ ë³´ë“œ */
        .game-panel { background: var(--panel-bg); border-radius: 15px; padding: 30px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .bet-input { background: #000; border: 1px solid #444; color: gold; padding: 12px; font-size: 20px; border-radius: 5px; width: 180px; text-align: center; }
        .btn-play { background: linear-gradient(to bottom, #ffd700, #b8860b); color: #000; border: none; padding: 15px 40px; font-weight: 900; border-radius: 5px; cursor: pointer; margin-top: 15px; }

        /* ë°”ì¹´ë¼ */
        .bac-table { background: radial-gradient(circle, #2e7d32, #1b5e20); border: 10px solid #3e2723; border-radius: 150px; padding: 40px; display: flex; justify-content: center; gap: 50px; margin: 20px 0; }
        .card-slot { width: 85px; height: 120px; background: rgba(0,0,0,0.2); border-radius: 5px; display: inline-block; position: relative; perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background: url('https://deckofcardsapi.com/static/img/back.png') center/cover; }
        .card-front { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg); background-size: cover; }
        .flipped { transform: rotateY(180deg); }

        /* ìŠ¬ë¡¯ */
        .slot-machine { background: #222; border: 6px solid #444; padding: 20px; border-radius: 10px; display: flex; justify-content: center; gap: 15px; margin: 20px auto; width: fit-content; }
        .reel { width: 90px; height: 120px; background: #fff; border-radius: 5px; overflow: hidden; position: relative; border: 2px solid #000; }
        .reel-strip { position: absolute; width: 100%; top: 0; }

        /* ë‹¬íŒ½ì´ */
        #snailCanvas { background: url('https://img.freepik.com/free-photo/green-grass-texture-background_1253-20.jpg') center; border-radius: 10px; border: 4px solid #5d4037; }

        .view { display: none; }
        .active-view { display: block; }
    </style>
</head>
<body>

    <div id="resultPopup">
        <h1 id="popTitle">WIN!</h1>
        <h2 id="popAmount" style="color:gold;">+ 0 KRW</h2>
        <button class="btn-play" onclick="closePopup()">í™•ì¸</button>
    </div>

    <div class="top-nav">
        <div class="logo" onclick="showView('lobby')">S SUPER 9 BET</div>
        <div class="nav-right">
            <div class="asset-box">KRW <span id="assetVal">0</span></div>
            <div class="user-menu">
                <span onclick="showView('myPage')">ì •ë³´ê´€ë¦¬</span>
                <span onclick="showView('csCenter')">ê³ ê°ì„¼í„°</span>
                <span onclick="handleLogout()" style="color:#ff5252;">ë¡œê·¸ì•„ì›ƒ</span>
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="sidebar">
            <div id="m-lobby" class="menu-item menu-active" onclick="showView('lobby')">HOME</div>
            <div id="m-slot" class="menu-item" onclick="showView('slotView')">SLOT 777</div>
            <div id="m-bac" class="menu-item" onclick="showView('bacView')">BACCARAT</div>
            <div id="m-snail" class="menu-item" onclick="showView('snailView')">SNAIL RACE</div>
        </div>

        <div class="content">
            <div id="lobby" class="view active-view">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div style="background:#400; padding:20px; border:2px solid red; font-weight:900; text-align:center;">âš ï¸ ì…ê¸ˆ ì „ ê³„ì¢Œ ë¬¸ì˜ í•„ìˆ˜ âš ï¸</div>
                    <div style="background:#004; padding:20px; border:2px solid blue; font-weight:900; text-align:center; color:#0cf;">ğŸ’ ì‹ ê·œ ê°€ì… 3+3 10+5 ì´ë²¤íŠ¸ ğŸ’</div>
                </div>
                <div class="game-panel">
                    <h1 style="color:gold;">PREMIUM CASINO SERVICE</h1>
                    <p>ì‹¤ì‹œê°„ ë¼ì´ë¸Œ ê²Œì„ê³¼ ê³ í•´ìƒë„ ìŠ¬ë¡¯ì„ ì¦ê²¨ë³´ì„¸ìš”.</p>
                </div>
            </div>

            <div id="slotView" class="view">
                <div class="game-panel">
                    <h2>ğŸ° MEGA JACKPOT SLOT</h2>
                    <div class="slot-machine">
                        <div class="reel"><div id="r1" class="reel-strip"></div></div>
                        <div class="reel"><div id="r2" class="reel-strip"></div></div>
                        <div class="reel"><div id="r3" class="reel-strip"></div></div>
                    </div>
                    <input type="number" id="slotBet" class="bet-input" value="10000"><br>
                    <button id="slotBtn" class="btn-play" onclick="playSlot()">SPIN START</button>
                </div>
            </div>

            <div id="bacView" class="view">
                <div class="game-panel">
                    <h2>ğŸƒ VIP BACCARAT</h2>
                    <div class="bac-table">
                        <div>
                            <p style="color:#4facfe; font-weight:900;">PLAYER</p>
                            <div id="pC1" class="card-slot"><div class="card-inner"><div class="card-back"></div><div class="card-front"></div></div></div>
                            <div id="pC2" class="card-slot"><div class="card-inner"><div class="card-back"></div><div class="card-front"></div></div></div>
                        </div>
                        <div>
                            <p style="color:#ff5252; font-weight:900;">BANKER</p>
                            <div id="bC1" class="card-slot"><div class="card-inner"><div class="card-back"></div><div class="card-front"></div></div></div>
                            <div id="bC2" class="card-slot"><div class="card-inner"><div class="card-back"></div><div class="card-front"></div></div></div>
                        </div>
                    </div>
                    <input type="number" id="bacBet" class="bet-input" value="10000"><br>
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="btn-play" style="background:#4facfe; color:#fff;" onclick="playBac('player')">PLAYER</button>
                        <button class="btn-play" style="background:#4caf50; color:#fff;" onclick="playBac('tie')">TIE</button>
                        <button class="btn-play" style="background:#ff5252; color:#fff;" onclick="playBac('banker')">BANKER</button>
                    </div>
                </div>
            </div>

            <div id="snailView" class="view">
                <div class="game-panel">
                    <h2>ğŸŒ REAL SNAIL RACING</h2>
                    <canvas id="snailCanvas" width="700" height="260"></canvas>
                    <div style="margin:20px 0; font-weight:900;">
                        <label><input type="radio" name="snailPick" value="0" checked> 1ë²ˆ ë‹¬íŒ½ì´</label>
                        <label style="margin-left:20px;"><input type="radio" name="snailPick" value="1"> 2ë²ˆ ë‹¬íŒ½ì´</label>
                        <label style="margin-left:20px;"><input type="radio" name="snailPick" value="2"> 3ë²ˆ ë‹¬íŒ½ì´</label>
                    </div>
                    <input type="number" id="snailBet" class="bet-input" value="10000"><br>
                    <button id="snailBtn" class="btn-play" onclick="playSnail()">RACE START</button>
                </div>
            </div>

            <div id="csCenter" class="view">
                <div class="game-panel" style="text-align:left;">
                    <h2>1:1 ë¬¸ì˜ì„¼í„° <span id="adminMark" style="display:none; color:gold;">[ê´€ë¦¬ì]</span></h2>
                    <div style="background:#000; padding:15px; border-radius:10px; margin-bottom:20px;">
                        <input type="text" id="csTitle" placeholder="ì œëª©" style="width:100%; margin-bottom:10px; background:#111; color:#fff; border:1px solid #333; padding:8px;">
                        <textarea id="csContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; height:80px; background:#111; color:#fff; border:1px solid #333; padding:8px;"></textarea>
                        <div style="margin-top:10px; display:flex; justify-content:space-between;">
                            <label><input type="checkbox" id="csSecret"> ë¹„ë°€ê¸€</label>
                            <button class="btn-play" style="padding:8px 20px; margin:0;" onclick="writeCS()">ë¬¸ì˜ ë“±ë¡</button>
                        </div>
                    </div>
                    <table style="width:100%; text-align:center;"><tbody id="csList"></tbody></table>
                </div>
            </div>

            <div id="myPage" class="view">
                <div class="game-panel">
                    <h2>íšŒì› ì •ë³´ ê´€ë¦¬</h2>
                    <p id="userEmail"></p>
                    <hr style="border-color:#333;">
                    <h3>ìµœê·¼ ê²Œì„ ê¸°ë¡</h3>
                    <table style="width:100%;" id="historyList"></table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, addDoc, getDocs, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDOVJtg5lxJTBP2Vm1mzbuecKu9Rg-I4k4", authDomain: "gambling-23339.firebaseapp.com", projectId: "gambling-23339", storageBucket: "gambling-23339.firebasestorage.app", messagingSenderId: "1031894079454", appId: "1:1031894079454:web:960ca0f1748493cdd9af4f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userObj = null, isAdmin = false, curBal = 0;

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                userObj = user;
                const snap = await getDoc(doc(db, "users", user.uid));
                const data = snap.data();
                isAdmin = data.role === 'admin';
                if(isAdmin) document.getElementById('adminMark').style.display = 'inline';
                updateAsset();
                initSlotSystem();
            } else { location.href = "login.html"; }
        });

        async function updateAsset() {
            const snap = await getDoc(doc(db, "users", userObj.uid));
            curBal = snap.data().balance;
            document.getElementById('assetVal').innerText = curBal.toLocaleString();
        }

        window.handleLogout = () => { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) signOut(auth).then(() => location.href="login.html"); };

        window.showView = (vid) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('menu-active'));
            document.getElementById(vid).classList.add('active-view');
            const mId = 'm-' + vid.replace('View','').replace('Center','').replace('myPage','lobby');
            if(document.getElementById(mId)) document.getElementById(mId).classList.add('menu-active');
            if(vid === 'csCenter') loadCS();
            if(vid === 'snailView') initSnail();
        };

        function openPopup(win, amount) {
            document.getElementById('popTitle').className = win ? 'win-title' : 'lose-title';
            document.getElementById('popTitle').innerText = win ? 'VICTORY!' : 'DEFEAT';
            document.getElementById('popAmount').innerText = (amount >= 0 ? '+' : '') + amount.toLocaleString() + " KRW";
            document.getElementById('resultPopup').style.display = 'block';
        }
        window.closePopup = () => document.getElementById('resultPopup').style.display = 'none';

        // --- ìŠ¬ë¡¯ (ì‹¤ì œ ë¦¬ì†ŒìŠ¤ ì´ë¯¸ì§€) ---
        const slotIcons = [
            'https://cdn-icons-png.flaticon.com/512/8141/8141830.png',
            'https://cdn-icons-png.flaticon.com/512/3242/3242008.png',
            'https://cdn-icons-png.flaticon.com/512/1045/1045508.png',
            'https://cdn-icons-png.flaticon.com/512/1656/1656858.png'
        ];
        function initSlotSystem() {
            [1,2,3].forEach(id => {
                const el = document.getElementById('r'+id);
                el.innerHTML = '';
                for(let i=0; i<40; i++) {
                    const img = document.createElement('img');
                    img.src = slotIcons[Math.floor(Math.random()*4)];
                    img.style.width = '100%'; img.style.height = '120px';
                    el.appendChild(img);
                }
            });
        }
        window.playSlot = async () => {
            const bet = parseInt(document.getElementById('slotBet').value);
            if(bet > curBal || bet <= 0) return alert("ì”ì•¡ ë¶€ì¡±");
            document.getElementById('slotBtn').disabled = true;

            [1,2,3].forEach((id, idx) => {
                const r = document.getElementById('r'+id);
                r.style.transition = `top ${2 + idx}s cubic-bezier(0.45, 0.05, 0.55, 0.95)`;
                const finalPos = -(Math.floor(Math.random()*20 + 10) * 120);
                r.style.top = finalPos + "px";
                if(idx === 2) {
                    setTimeout(async () => {
                        const win = Math.random() > 0.7;
                        const profit = win ? (bet * 5.8) - bet : -bet;
                        await updateDoc(doc(db, "users", userObj.uid), { balance: increment(profit) });
                        updateAsset();
                        openPopup(win, profit);
                        document.getElementById('slotBtn').disabled = false;
                        setTimeout(() => { [1,2,3].forEach(i=> { document.getElementById('r'+i).style.transition='none'; document.getElementById('r'+i).style.top='0'; }); }, 1000);
                    }, 4000);
                }
            });
        };

        // --- ë°”ì¹´ë¼ (í˜„ì¥ê° ì¹´ë“œ) ---
        window.playBac = async (pick) => {
            const bet = parseInt(document.getElementById('bacBet').value);
            if(bet > curBal || bet <= 0) return alert("ì”ì•¡ ë¶€ì¡±");
            const slots = ['pC1', 'pC2', 'bC1', 'bC2'];
            slots.forEach(s => document.querySelector(`#${s} .card-inner`).classList.remove('flipped'));
            
            const getC = () => {
                const n = Math.floor(Math.random()*13)+1;
                const s = ['H','S','D','C'][Math.floor(Math.random()*4)];
                let char = n===1?'A':n===11?'J':n===12?'Q':n===13?'K':n===10?'0':n;
                return { v: n > 10 ? 0 : n, url: `https://deckofcardsapi.com/static/img/${char}${s}.png` };
            };
            const cards = [getC(), getC(), getC(), getC()];

            for(let i=0; i<4; i++) {
                await new Promise(r => setTimeout(r, 800));
                document.querySelector(`#${slots[i]} .card-front`).style.backgroundImage = `url(${cards[i].url})`;
                document.querySelector(`#${slots[i]} .card-inner`).classList.add('flipped');
            }

            const pS = (cards[0].v + cards[2].v) % 10;
            const bS = (cards[1].v + cards[3].v) % 10;
            const win = pS > bS ? 'player' : (bS > pS ? 'banker' : 'tie');
            const profit = (pick === win) ? (win === 'tie' ? bet * 9.8 : bet * 2.8) - bet : -bet;

            setTimeout(async () => {
                await updateDoc(doc(db, "users", userObj.uid), { balance: increment(profit) });
                updateAsset();
                openPopup(profit > 0, profit);
            }, 500);
        };

        // --- ë‹¬íŒ½ì´ (ì‹¤ì œ ë ˆì´ì‹±) ---
        let snX = [10, 10, 10];
        const snImg = new Image(); snImg.src = "https://cdn-icons-png.flaticon.com/512/2823/2823377.png";
        window.initSnail = () => {
            const ctx = document.getElementById('snailCanvas').getContext('2d');
            function frame() {
                ctx.clearRect(0,0,700,260);
                snX.forEach((x, i) => { ctx.drawImage(snImg, x, 25 + (i*80), 75, 55); });
                requestAnimationFrame(frame);
            }
            frame();
        };
        window.playSnail = async () => {
            const bet = parseInt(document.getElementById('snailBet').value);
            const pick = parseInt(document.querySelector('input[name="snailPick"]:checked').value);
            document.getElementById('snailBtn').disabled = true;
            const race = setInterval(async () => {
                let winner = -1;
                snX = snX.map((x, i) => {
                    const nx = x + Math.random() * 4;
                    if(nx > 610) winner = i;
                    return nx;
                });
                if(winner !== -1) {
                    clearInterval(race);
                    const win = (winner === pick);
                    const profit = win ? (bet * 2.8) - bet : -bet;
                    await updateDoc(doc(db, "users", userObj.uid), { balance: increment(profit) });
                    updateAsset();
                    openPopup(win, profit);
                    snX = [10,10,10]; document.getElementById('snailBtn').disabled = false;
                }
            }, 50);
        };

        // --- ê³ ê°ì„¼í„° ---
        window.writeCS = async () => {
            const title = document.getElementById('csTitle').value;
            const content = document.getElementById('csContent').value;
            if(!title || !content) return;
            await addDoc(collection(db, "cs"), { uid: userObj.uid, email: userObj.email, title, content, secret: document.getElementById('csSecret').checked, time: new Date().toISOString() });
            document.getElementById('csTitle').value = ""; document.getElementById('csContent').value = "";
            loadCS();
        };
        window.loadCS = async () => {
            const q = query(collection(db, "cs"), orderBy("time", "desc"));
            const snap = await getDocs(q);
            document.getElementById('csList').innerHTML = snap.docs.map(docSnap => {
                const d = docSnap.data();
                const canSee = !d.secret || d.uid === userObj.uid || isAdmin;
                return `<tr><td style="padding:10px; border-bottom:1px solid #222;">${d.secret?'ğŸ”’':'ğŸ“¢'}</td><td style="cursor:pointer; text-align:left;" onclick="alert('${canSee?d.content:'ë¹„ë°€ê¸€ì…ë‹ˆë‹¤.'}')">${canSee?d.title:'ë¹„ë°€ê¸€ì…ë‹ˆë‹¤.'}</td><td>${d.email.split('@')[0]}</td><td>${isAdmin?`<button onclick="deleteCS('${docSnap.id}')" style="color:red; background:none; border:none; cursor:pointer;">ì‚­ì œ</button>`:'-'}</td></tr>`;
            }).join('');
        };
        window.deleteCS = async (id) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await deleteDoc(doc(db, "cs", id)); loadCS(); } };
    </script>
</body>
</html>